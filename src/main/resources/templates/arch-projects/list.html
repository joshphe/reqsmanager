<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>架构项目管理</title>
</head>
<body>
<div th:fragment="content">
  <h1>架构项目管理</h1>
  <hr>
  <!-- === START: 新增，用于显示导入结果的提示框 === -->
  <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
    <span th:text="${success}"></span>
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
    <span th:text="${error}"></span>
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <!-- === END === -->

  <!-- 顶部操作栏：筛选和新增 -->
  <div class="d-flex justify-content-between mb-3">
    <form th:action="@{/arch-projects/}" method="get" class="form-inline">
      <input type="text" name="reqId" th:value="${reqId}" placeholder="按需求编号筛选" class="form-control mr-2">
      <input type="hidden" name="size" th:value="${page.size}">
      <button type="submit" class="btn btn-primary">筛选</button>
      <a th:href="@{/arch-projects/}" class="btn btn-secondary ml-2">清空筛选</a>
    </form>

    <!-- === START: 按钮组 === -->
    <div>
      <a th:href="@{/arch-projects/template}" class="btn btn-outline-secondary">下载导入模板</a>
      <button type="button" class="btn btn-secondary ml-2" data-toggle="modal" data-target="#importModal">
        批量导入
      </button>
      <a th:href="@{/arch-projects/create}" class="btn btn-success">新增项目</a>
      <!-- 新增导出按钮 -->
      <a th:href="@{/arch-projects/export}" class="btn btn-info ml-2">导出 CSV</a>
    </div>
    <!-- === END: 按钮组 === -->
  </div>

  <!-- 表格容器 -->
  <div class="table-responsive">
    <table class="table table-bordered table-striped">
      <thead class="thead-dark">
      <tr>
        <th class="frozen col-1 col-project-number">项目编号</th>
        <th class="frozen col-2 col-req-id">需求编号</th>
        <th class="frozen col-3 col-req-name">需求名称</th>
        <!-- 2025-12-15 新增项目所属开发部室、项目负责人 === START: 新增表头 === -->
        <th>开发部室</th>
        <th>项目负责人</th>
        <!-- === END: 新增表头 === -->
        <th>是否重点项目</th>
        <th>可行性方案递交人</th>
        <th>可行性方案递交日期</th>
        <th>可行性方案评审通过日期</th>
        <th>总体设计递交人</th>
        <th>总体设计递交日期</th>
        <th>总体设计评审通过日期</th>
        <th>详细设计递交人</th>
        <th>详细设计递交日期</th>
        <th>可行性方案评分</th>
        <th>可行性方案扣分原因</th>
        <th>总体设计评分</th>
        <th>总体设计扣分原因</th>
        <th>详细设计评分</th>
        <th>详细设计扣分原因</th>
        <th>备注</th>
        <th class="frozen col-last col-actions">操作</th>
      </tr>
      </thead>
      <tbody>
      <tr th:if="${page.empty}">
        <td colspan="20" class="text-center">没有找到相关项目</td>
      </tr>
      <tr th:each="proj : ${page.content}">
        <td class="frozen col-1 col-project-number" th:text="${proj.projectNumber}"></td>
        <td class="frozen col-2 col-req-id" th:text="${proj.reqId}"></td>
        <td class="frozen col-3 col-req-name" th:text="${proj.reqName}"></td>
        <!-- === START: 新增数据列 === -->
        <td th:text="${proj.devDepartment}"></td>
        <td th:text="${proj.projectManager}"></td>
        <!-- === END: 新增数据列 === -->
        <td th:text="${proj.keyProject ? '是' : '否'}"></td>
        <td th:text="${proj.feasibilitySubmitter}"></td>

        <!-- === START: 修正“可行性方案递交日期”列 === -->
        <td>
                    <span th:style="${proj.feasibilitySubmitDate == null} ? 'color: red; font-weight: bold;' : 'color: black;'"
                          th:text="${proj.feasibilitySubmitDate != null ? #temporals.format(proj.feasibilitySubmitDate, 'yyyy-MM-dd') : '未递交'}">
                    </span>
        </td>
        <!-- === END: 修正 === -->

        <td th:text="${proj.feasibilityReviewPassDate != null ? #temporals.format(proj.feasibilityReviewPassDate, 'yyyy-MM-dd') : ''}"></td>
        <td th:text="${proj.generalDesignSubmitter}"></td>

        <!-- === START: 修正“总体设计递交日期”列 === -->
        <td>
                    <span th:style="${proj.generalDesignSubmitDate == null} ? 'color: red; font-weight: bold;' : 'color: black;'"
                          th:text="${proj.generalDesignSubmitDate != null ? #temporals.format(proj.generalDesignSubmitDate, 'yyyy-MM-dd') : '未递交'}">
                    </span>
        </td>
        <!-- === END: 修正 === -->

        <td th:text="${proj.generalDesignReviewPassDate != null ? #temporals.format(proj.generalDesignReviewPassDate, 'yyyy-MM-dd') : ''}"></td>
        <td th:text="${proj.detailedDesignSubmitter}"></td>

        <!-- === START: 修正“详细设计递交日期”列 === -->
        <td>
                    <span th:style="${proj.detailedDesignSubmitDate == null} ? 'color: red; font-weight: bold;' : 'color: black;'"
                          th:text="${proj.detailedDesignSubmitDate != null ? #temporals.format(proj.detailedDesignSubmitDate, 'yyyy-MM-dd') : '未递交'}">
                    </span>
        </td>
        <!-- === END: 修正 === -->

        <td th:text="${proj.feasibilityScore}"></td>
        <td th:text="${proj.feasibilityDeductionReason}"></td>
        <td th:text="${proj.generalDesignScore}"></td>
        <td th:text="${proj.generalDesignDeductionReason}"></td>
        <td th:text="${proj.detailedDesignScore}"></td>
        <td th:text="${proj.detailedDesignDeductionReason}"></td>
        <td th:text="${proj.remarks}"></td>
        <td class="frozen col-last col-actions">
          <a th:href="@{/arch-projects/edit/{id}(id=${proj.id})}" class="btn btn-warning btn-sm">维护</a>
          <a th:href="@{/arch-projects/delete/{id}(id=${proj.id})}" class="btn btn-danger btn-sm ml-2" onclick="return confirm('确定要删除这个项目吗？');">删除</a>
        </td>
      </tr>
      </tbody>
    </table>
  </div>

  <!-- 分页控件 -->
  <div th:if="${page.totalPages > 0}" class="d-flex justify-content-end mt-3">
    <nav aria-label="Page navigation">
      <ul class="pagination">
        <li class="page-item" th:classappend="${page.first} ? 'disabled'"><a class="page-link" th:href="@{/arch-projects/(size=${page.size}, page=0, reqId=${reqId})}">首页</a></li>
        <li class="page-item" th:classappend="${page.first} ? 'disabled'"><a class="page-link" th:href="@{/arch-projects/(size=${page.size}, page=${page.number - 1}, reqId=${reqId})}">上一页</a></li>
        <li class="page-item" th:each="i : ${#numbers.sequence(0, page.totalPages - 1)}" th:classappend="${i == page.number} ? 'active'"><a class="page-link" th:href="@{/arch-projects/(size=${page.size}, page=${i}, reqId=${reqId})}" th:text="${i + 1}"></a></li>
        <li class="page-item" th:classappend="${page.last} ? 'disabled'"><a class="page-link" th:href="@{/arch-projects/(size=${page.size}, page=${page.number + 1}, reqId=${reqId})}">下一页</a></li>
        <li class="page-item" th:classappend="${page.last} ? 'disabled'"><a class="page-link" th:href="@{/arch-projects/(size=${page.size}, page=${page.totalPages - 1}, reqId=${reqId})}">尾页</a></li>
      </ul>
    </nav>
  </div>
  <!-- === START: 新增，文件上传的模态弹窗 === -->
  <div class="modal fade" id="importModal" tabindex="-1" role="dialog" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="importModalLabel">批量导入项目</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <!-- 文件上传表单 -->
        <form th:action="@{/arch-projects/import}" method="post" enctype="multipart/form-data">
          <div class="modal-body">
            <p>请选择要上传的 CSV 文件。系统将根据“项目编号”跳过已存在的记录。</p>
            <div class="custom-file">
              <input type="file" class="custom-file-input" id="csvFile" name="file" accept=".csv" required>
              <label class="custom-file-label" for="csvFile">选择文件...</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
            <button type="submit" class="btn btn-primary">上传并导入</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!-- === START: JavaScript 部分 === -->
  <script th:inline="javascript">
    /*<![CDATA[*/
    (function($) {
      if (typeof $ === 'undefined') { return; }
      $(document).ready(function() {
        // Custom file input label update
        $('.custom-file-input').on('change', function() {
          var fileName = $(this).val().split('\\').pop();
          $(this).next('.custom-file-label').html(fileName);
        });
      });
    })(jQuery);
    /*]]>*/
  </script>
  <!-- === END === -->
</div>
</body>
</html>
