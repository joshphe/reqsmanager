<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>架构项目管理</title>
</head>
<body>
<div th:fragment="content">
  <h1>架构项目管理</h1>
  <hr>
  <!-- === START: 新增，用于显示导入结果的提示框 === -->
  <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
    <span th:text="${success}"></span>
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
    <span th:text="${error}"></span>
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <!-- === END === -->

  <!-- === START: 筛选表单和操作按钮的整体布局 === -->
  <div class="mb-3">
    <form th:action="@{/arch-projects/}" method="get">
      <input type="hidden" name="size" th:value="${page.size}"> <!-- 隐藏域，保持每页显示条数 -->

      <!-- 筛选条件 - 第一行 (项目编号 / 需求编号 / 需求名称) -->
      <div class="form-row align-items-center mb-2">
        <div class="col-md-4 form-group">
          <label class="col-form-label mr-2">项目编号:</label>
          <input type="text" id="filterProjectNumber" name="projectNumber" th:value="${projectNumber}" class="form-control" placeholder="项目编号">
        </div>
        <div class="col-md-4 form-group">
          <label class="col-form-label mr-2">需求编号:</label>
          <input type="text" id="filterReqId" name="reqId" th:value="${reqId}" class="form-control" placeholder="需求编号">
        </div>
        <div class="col-md-4 form-group">
          <label class="col-form-label mr-2">需求名称:</label>
          <input type="text" id="filterReqName" name="reqName" th:value="${reqName}" class="form-control" placeholder="需求名称">
        </div>
        <div class="col-md-4 form-group">
          <label class="col-form-label mr-2">项目负责人:</label>
          <input type="text" id="filterProjectManager" name="projectManager" th:value="${projectManager}" class="form-control" placeholder="项目负责人">
        </div>
        <div class="col-md-4 form-group">
          <label class="col-form-label mr-2">是否重点项目:</label>
          <select name="isKeyProject" class="form-control">
            <option value="">-- 请选择 --</option>
            <option value="true" th:selected="${isKeyProject != null and isKeyProject}">是</option>
            <option value="false" th:selected="${isKeyProject != null and !isKeyProject}">否</option>
          </select>
        </div>
      </div>

      <!-- 筛选条件 - 第二行 (项目负责人 / 是否重点项目 / 筛选按钮) -->
      <div class="form-row align-items-center mb-3">
        <!-- 筛选和清空按钮 -->
        <div class="col-md-4 form-group text-left"> <!-- 占据剩余宽度并右对齐 -->
          <button type="submit" class="btn btn-primary">筛选</button>
          <a th:href="@{/arch-projects/}" class="btn btn-secondary ml-2">清空</a>
        </div>
      </div>
    </form>

    <!-- 操作按钮组 (新增/导入/导出) -->
    <div class="d-flex justify-content-end mb-3">
      <a th:href="@{/arch-projects/template}" class="btn btn-outline-secondary">下载导入模板</a>
      <button type="button" class="btn btn-secondary ml-2" data-toggle="modal" data-target="#importModal">批量导入</button>
      <a th:href="@{/arch-projects/create}" class="btn btn-success ml-2">新增项目</a>
      <a th:href="@{/arch-projects/export}" class="btn btn-info ml-2">导出 CSV</a>
    </div>
  </div>

  <!-- 表格容器 -->
  <div class="table-responsive">
    <table class="table table-bordered table-striped">
      <thead class="thead-dark">
      <tr>
        <th class="frozen col-1 col-project-number">项目编号</th>
        <th class="frozen col-2 col-req-id">需求编号</th>
        <th class="frozen col-3 col-req-name">需求名称</th>
        <!-- 2025-12-15 新增项目所属开发部室、项目负责人 === START: 新增表头 === -->
        <th>开发部室</th>
        <th>项目负责人</th>
        <!-- === END: 新增表头 === -->
        <th>是否重点项目</th>
        <th>可行性方案递交人</th>
        <th>可行性方案递交日期</th>
        <th>可行性方案评审通过日期</th>
        <th>总体设计递交人</th>
        <th>总体设计递交日期</th>
        <th>总体设计评审通过日期</th>
        <th>详细设计递交人</th>
        <th>详细设计递交日期</th>
        <th>可行性方案评分</th>
        <th>可行性方案扣分原因</th>
        <th>总体设计评分</th>
        <th>总体设计扣分原因</th>
        <th>详细设计评分</th>
        <th>详细设计扣分原因</th>
        <th>备注</th>
        <th class="frozen col-last col-actions">操作</th>
      </tr>
      </thead>
      <tbody>
      <tr th:if="${page.empty}">
        <td colspan="20" class="text-center">没有找到相关项目</td>
      </tr>
      <tr th:each="proj : ${page.content}">
        <td class="frozen col-1 col-project-number" th:text="${proj.projectNumber}"></td>
        <td class="frozen col-2 col-req-id" th:text="${proj.reqId}"></td>
        <td class="frozen col-3 col-req-name" th:text="${proj.reqName}"></td>
        <!-- === START: 新增数据列 === -->
        <td th:text="${proj.devDepartment}"></td>
        <td th:text="${proj.projectManager}"></td>
        <!-- === END: 新增数据列 === -->
        <td th:text="${proj.keyProject ? '是' : '否'}"></td>
        <td th:text="${proj.feasibilitySubmitter}"></td>

        <!-- === START: 修正“可行性方案递交日期”列 === -->
        <td>
                    <span th:style="${proj.feasibilitySubmitDate == null} ? 'color: red; font-weight: bold;' : 'color: black;'"
                          th:text="${proj.feasibilitySubmitDate != null ? #temporals.format(proj.feasibilitySubmitDate, 'yyyy-MM-dd') : '未递交'}">
                    </span>
        </td>
        <!-- === END: 修正 === -->

        <td th:text="${proj.feasibilityReviewPassDate != null ? #temporals.format(proj.feasibilityReviewPassDate, 'yyyy-MM-dd') : ''}"></td>
        <td th:text="${proj.generalDesignSubmitter}"></td>

        <!-- === START: 修正“总体设计递交日期”列 === -->
        <td>
                    <span th:style="${proj.generalDesignSubmitDate == null} ? 'color: red; font-weight: bold;' : 'color: black;'"
                          th:text="${proj.generalDesignSubmitDate != null ? #temporals.format(proj.generalDesignSubmitDate, 'yyyy-MM-dd') : '未递交'}">
                    </span>
        </td>
        <!-- === END: 修正 === -->

        <td th:text="${proj.generalDesignReviewPassDate != null ? #temporals.format(proj.generalDesignReviewPassDate, 'yyyy-MM-dd') : ''}"></td>
        <td th:text="${proj.detailedDesignSubmitter}"></td>

        <!-- === START: 修正“详细设计递交日期”列 === -->
        <td>
                    <span th:style="${proj.detailedDesignSubmitDate == null} ? 'color: red; font-weight: bold;' : 'color: black;'"
                          th:text="${proj.detailedDesignSubmitDate != null ? #temporals.format(proj.detailedDesignSubmitDate, 'yyyy-MM-dd') : '未递交'}">
                    </span>
        </td>
        <!-- === END: 修正 === -->

        <td th:text="${proj.feasibilityScore}"></td>
        <td th:text="${proj.feasibilityDeductionReason}"></td>
        <td th:text="${proj.generalDesignScore}"></td>
        <td th:text="${proj.generalDesignDeductionReason}"></td>
        <td th:text="${proj.detailedDesignScore}"></td>
        <td th:text="${proj.detailedDesignDeductionReason}"></td>
        <td th:text="${proj.remarks}"></td>
        <td class="frozen col-last col-actions">
          <a th:href="@{/arch-projects/edit/{id}(id=${proj.id})}" class="btn btn-warning btn-sm">维护</a>
          <a th:href="@{/arch-projects/delete/{id}(id=${proj.id})}" class="btn btn-danger btn-sm ml-2" onclick="return confirm('确定要删除这个项目吗？');">删除</a>
        </td>
      </tr>
      </tbody>
    </table>
  </div>

  <!-- 分页控件 -->
  <div th:if="${page.totalPages > 0}" class="d-flex justify-content-end mt-3">
    <nav aria-label="Page navigation">
      <ul class="pagination">
        <!-- === START: 确保分页链接包含所有筛选参数 === -->
        <li class="page-item" th:classappend="${page.first} ? 'disabled'">
          <a class="page-link" th:href="@{/arch-projects/(size=${page.size}, page=0, projectNumber=${projectNumber}, reqId=${reqId}, reqName=${reqName}, projectManager=${projectManager}, isKeyProject=${isKeyProject})}">首页</a>
        </li>
        <li class="page-item" th:classappend="${page.first} ? 'disabled'">
          <a class="page-link" th:href="@{/arch-projects/(size=${page.size}, page=${page.number - 1}, projectNumber=${projectNumber}, reqId=${reqId}, reqName=${reqName}, projectManager=${projectManager}, isKeyProject=${isKeyProject})}">上一页</a>
        </li>
        <li class="page-item" th:each="i : ${#numbers.sequence(0, page.totalPages - 1)}" th:classappend="${i == page.number} ? 'active'">
          <a class="page-link" th:href="@{/arch-projects/(size=${page.size}, page=${i}, projectNumber=${projectNumber}, reqId=${reqId}, reqName=${reqName}, projectManager=${projectManager}, isKeyProject=${isKeyProject})}" th:text="${i + 1}"></a>
        </li>
        <li class="page-item" th:classappend="${page.last} ? 'disabled'">
          <a class="page-link" th:href="@{/arch-projects/(size=${page.size}, page=${page.number + 1}, projectNumber=${projectNumber}, reqId=${reqId}, reqName=${reqName}, projectManager=${projectManager}, isKeyProject=${isKeyProject})}">下一页</a>
        </li>
        <li class="page-item" th:classappend="${page.last} ? 'disabled'">
          <a class="page-link" th:href="@{/arch-projects/(size=${page.size}, page=${page.totalPages - 1}, projectNumber=${projectNumber}, reqId=${reqId}, reqName=${reqName}, projectManager=${projectManager}, isKeyProject=${isKeyProject})}">尾页</a>
        </li>
        <!-- === END === -->
      </ul>
    </nav>
  </div>
  <!-- === START: 新增，文件上传的模态弹窗 === -->
  <div class="modal fade" id="importModal" tabindex="-1" role="dialog" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="importModalLabel">批量导入项目</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <!-- 文件上传表单 -->
        <form th:action="@{/arch-projects/import}" method="post" enctype="multipart/form-data">
          <div class="modal-body">
            <p>请选择要上传的 CSV 文件。系统将根据“项目编号”跳过已存在的记录。</p>
            <div class="custom-file">
              <input type="file" class="custom-file-input" id="csvFile" name="file" accept=".csv" required>
              <label class="custom-file-label" for="csvFile">选择文件...</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
            <button type="submit" class="btn btn-primary">上传并导入</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!-- === START: JavaScript 部分 === -->
  <script th:inline="javascript">
    /*<![CDATA[*/
    (function($) {
      if (typeof $ === 'undefined') { return; }
      $(document).ready(function() {
        // Custom file input label update
        $('.custom-file-input').on('change', function() {
          var fileName = $(this).val().split('\\').pop();
          $(this).next('.custom-file-label').html(fileName);
        });
      });
    })(jQuery);
    /*]]>*/
  </script>
  <!-- === END === -->
</div>
</body>
</html>
