<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>需求管理</title>
</head>
<body>
<div th:fragment="content">
    <h1>需求管理</h1>
    <hr>

    <!-- === START: 新增，用于显示导入结果的提示框 === -->
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
        <span th:text="${success}"></span>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${error}"></span>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <!-- === END === -->

    <!-- === START: 筛选表单和操作按钮的整体布局 === -->
    <div class="mb-3">
        <form th:action="@{/requirements/}" method="get">
            <input type="hidden" name="size" th:value="${page.size}"> <!-- 隐藏域，保持每页显示条数 -->

            <!-- 筛选条件 - 第一行 (需求编号 / 需求名称 / 科技负责人) -->
            <div class="form-row align-items-center mb-2">
                <div class="col-md-4 form-group">
                    <label class="col-form-label mr-2">需求编号:</label>
                    <input type="text" name="reqId" th:value="${reqId}" class="form-control" placeholder="需求编号">
                </div>
                <div class="col-md-4 form-group">
                    <label class="col-form-label mr-2">需求名称:</label>
                    <input type="text" name="reqName" th:value="${reqName}" class="form-control" placeholder="需求名称">
                </div>
                <div class="col-md-4 form-group">
                    <label class="col-form-label mr-2">科技负责人:</label>
                    <input type="text" name="techLeader" th:value="${techLeader}" class="form-control" placeholder="科技负责人">
                </div>
                <div class="col-md-4 form-group">
                    <label class="col-form-label mr-2">起始日期:</label>
                    <input type="date" name="startDate" th:value="${startDate}" class="form-control">
                </div>
                <div class="col-md-4 form-group">
                    <label class="col-form-label mr-2">结束日期:</label>
                    <input type="date" name="endDate" th:value="${endDate}" class="form-control">
                </div>
                <!-- === START: 核心修正：将 select 放入 col-md-4 form-group === -->
                <div class="col-md-4 form-group">
                    <label class="col-form-label mr-2">需求状态:</label>
                    <select name="status" class="form-control">
                        <option value="">-- 需求状态 --</option>
                        <option value="进行中" th:selected="${status == '进行中'}">进行中</option>
                        <option value="已投产" th:selected="${status == '已投产'}">已投产</option>
                    </select>
                </div>
                <!-- === END === -->
            </div>

            <!-- 筛选条件 - 第二行 (需求排期 / 筛选按钮 / 清空按钮) -->
            <div class="form-row align-items-center mb-3">
                <!-- 筛选和清空按钮 -->
                <div class="col-md-4 form-group text-left"> <!-- 占据剩余宽度并右对齐 -->
                    <button type="submit" class="btn btn-primary">筛选</button>
                    <a th:href="@{/requirements/}" class="btn btn-secondary ml-2">清空</a>
                </div>
            </div>
        </form>
        <!-- 新增按钮 -->
        <div class="d-flex justify-content-end mb-3">
            <button type="button" class="btn btn-warning" id="batchUpdateBtn">一键更新</button>
            <button type="button" class="btn btn-danger ml-2" id="batchDeleteBtn">批量删除</button>
            <a th:href="@{/requirements/template}" class="btn btn-outline-secondary ml-2">下载导入模板</a>
            <button type="button" class="btn btn-secondary ml-2" data-toggle="modal" data-target="#importModal">批量导入</button>
            <a th:href="@{/requirements/create}" class="btn btn-success ml-2">新增需求</a>
            <a th:href="@{/requirements/export}" class="btn btn-info ml-2">导出 CSV</a>
        </div>
    </div>

    <!-- 需求列表表格 -->
    <div class="table-responsive">
        <table class="table table-bordered table-striped">
            <thead class="thead-dark">
            <tr>
                <!-- === START: 新增“全选”复选框 === -->
                <th style="width: 50px;" class="text-center">
                    <input type="checkbox" id="selectAllCheckbox">
                </th>
                <!-- === END === -->
                <th class="frozen col-1 col-req-id">需求编号</th>
                <th class="frozen col-2 col-req-name">需求名称</th>
                <th>需求业务负责人</th>
                <th>需求科技负责人</th>
                <!-- === START: 新增表头 === -->
                <th>牵头部室</th>
                <!-- === START: 新增表头 === -->
                <th>所属小组</th>
                <!-- === END: 新增表头 === -->
                <th>需求类型</th>
                <!-- === END: 新增表头 === -->
                <th>业务条线</th>
                <th>开发负责人</th>
                <th class="col-schedule-date">需求排期</th>
                <th>需求状态</th>
                <th class="frozen col-last col-actions">操作</th>
            </tr>
            </thead>
            <tbody>
            <!-- 如果列表为空，显示提示 -->
            <tr th:if="${page.empty}">
                <td colspan="12" class="text-center">没有找到相关需求</td>
            </tr>
            <!-- 遍历并显示数据 -->
            <tr th:each="req : ${page.content}">
                <!-- === START: 新增“单选”复选框 === -->
                <td class="text-center">
                    <input type="checkbox" class="req-checkbox" th:value="${req.id}">
                </td>
                <!-- === END === -->
                <td class="frozen col-1 col-req-id" th:text="${req.reqId}"></td>
                <td class="frozen col-2 col-req-name" th:text="${req.name}"></td>
                <td th:text="${req.businessLeader}"></td>
                <td th:text="${req.techLeader}"></td>
                <!-- === START: 新增数据列 === -->
                <td th:text="${req.leadDepartment}"></td>
                <!-- === START: 新增数据列 === -->
                <td th:text="${req.groupName}"></td>
                <!-- === END: 新增数据列 === -->
                <td th:text="${req.reqType}"></td>
                <!-- === END: 新增数据列 === -->
                <td th:text="${req.businessLine}"></td>
                <td th:text="${req.devLeader}"></td>
                <td class="col-schedule-date" th:text="${req.scheduleDate != null ? #temporals.format(req.scheduleDate, 'yyyy-MM-dd') : ''}"></td>
                <!-- === START: 新增数据列 === -->
                <td th:text="${req.status}"></td>
                <!-- === END === -->
                <td class="frozen col-last col-actions">
                    <a th:href="@{/requirements/edit/{id}(id=${req.id})}" class="btn btn-warning btn-sm">编辑</a>
                    <a th:href="@{/requirements/delete/{id}(id=${req.id})}"
                       class="btn btn-danger btn-sm ml-2"
                       onclick="return confirm('确定要删除这条需求吗？删除后不可恢复！');">删除</a>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- 分页控件 -->
    <div th:if="${page.totalPages > 0}" class="d-flex justify-content-end mt-3">
        <nav aria-label="Page navigation">
            <ul class="pagination">
                <!-- === START: 确保分页链接包含所有筛选参数 === -->
                <li class="page-item" th:classappend="${page.first} ? 'disabled'">
                    <a class="page-link" th:href="@{/requirements/(size=${page.size}, page=0, reqId=${reqId}, reqName=${reqName}, techLeader=${techLeader}, startDate=${startDate}, endDate=${endDate})}">首页</a>
                </li>
                <li class="page-item" th:classappend="${page.first} ? 'disabled'">
                    <a class="page-link" th:href="@{/requirements/(size=${page.size}, page=${page.number - 1}, reqId=${reqId}, reqName=${reqName}, techLeader=${techLeader}, startDate=${startDate}, endDate=${endDate})}">上一页</a>
                </li>
                <li class="page-item" th:each="i : ${#numbers.sequence(0, page.totalPages - 1)}" th:classappend="${i == page.number} ? 'active'">
                    <a class="page-link" th:href="@{/requirements/(size=${page.size}, page=${i}, reqId=${reqId}, reqName=${reqName}, techLeader=${techLeader}, startDate=${startDate}, endDate=${endDate})}" th:text="${i + 1}"></a>
                </li>
                <li class="page-item" th:classappend="${page.last} ? 'disabled'">
                    <a class="page-link" th:href="@{/requirements/(size=${page.size}, page=${page.number + 1}, reqId=${reqId}, reqName=${reqName}, techLeader=${techLeader}, startDate=${startDate}, endDate=${endDate})}">下一页</a>
                </li>
                <li class="page-item" th:classappend="${page.last} ? 'disabled'">
                    <a class="page-link" th:href="@{/requirements/(size=${page.size}, page=${page.totalPages - 1}, reqId=${reqId}, reqName=${reqName}, techLeader=${techLeader}, startDate=${startDate}, endDate=${endDate})}">尾页</a>
                </li>
                <!-- === END === -->
            </ul>
        </nav>
    </div>

    <!-- === START: 新增，文件上传的模态弹窗 === -->
    <div class="modal fade" id="importModal" tabindex="-1" role="dialog" aria-labelledby="importModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="importModalLabel">批量导入需求</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <!-- 文件上传表单 -->
                <form th:action="@{/requirements/import}" method="post" enctype="multipart/form-data">
                    <div class="modal-body">
                        <p>请选择要上传的 CSV 文件。系统将根据“需求编号”跳过已存在的记录。</p>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="csvFile" name="file" accept=".csv" required>
                            <label class="custom-file-label" for="csvFile">选择文件...</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                        <button type="submit" class="btn btn-primary">上传并导入</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- === END === -->
</div>
</body>
</html>
