<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>需求管理</title>
</head>
<body>
<div th:fragment="content">
    <h1>需求管理</h1>
    <hr>

    <!-- === START: 新增，用于显示导入结果的提示框 === -->
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
        <span th:text="${success}"></span>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${error}"></span>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <!-- === END === -->

    <!-- 顶部操作栏：筛选和新增 -->
    <div class="d-flex justify-content-between mb-3">
        <!-- 筛选表单 -->
        <form th:action="@{/requirements/}" method="get" class="form-inline">
            <input type="text" name="reqId" th:value="${reqId}" placeholder="输入需求编号筛选" class="form-control mr-2">
            <!-- 隐藏域，在筛选时保持分页大小不变 -->
            <input type="hidden" name="size" th:value="${page.size}">
            <button type="submit" class="btn btn-primary">筛选</button>
            <a th:href="@{/requirements/}" class="btn btn-secondary ml-2">清空筛选</a>
        </form>

        <!-- 新增按钮 -->
        <div>
            <!-- === START: 新增“批量导入”按钮 === -->
            <button type="button" class="btn btn-secondary" data-toggle="modal" data-target="#importModal">
                批量导入
            </button>
            <!-- === END === -->
            <a th:href="@{/requirements/create}" class="btn btn-success">新增需求</a>
            <!-- 新增导出按钮 -->
            <a th:href="@{/requirements/export}" class="btn btn-info ml-2">导出 CSV</a>
        </div>
    </div>

    <!-- 需求列表表格 -->
    <div class="table-responsive">
        <table class="table table-bordered table-striped">
            <thead class="thead-dark">
            <tr>
                <th class="frozen col-1 col-req-id">需求编号</th>
                <th class="frozen col-2 col-req-name">需求名称</th>
                <th>需求业务负责人</th>
                <th>需求科技负责人</th>
                <!-- === START: 新增表头 === -->
                <th>牵头部室</th>
                <!-- === START: 新增表头 === -->
                <th>所属小组</th>
                <!-- === END: 新增表头 === -->
                <th>需求类型</th>
                <!-- === END: 新增表头 === -->
                <th>业务条线</th>
                <th>开发负责人</th>
                <th class="col-schedule-date">需求排期</th>
                <th class="frozen col-last col-actions">操作</th>
            </tr>
            </thead>
            <tbody>
            <!-- 如果列表为空，显示提示 -->
            <tr th:if="${page.empty}">
                <td colspan="8" class="text-center">没有找到相关需求</td>
            </tr>
            <!-- 遍历并显示数据 -->
            <tr th:each="req : ${page.content}">
                <td class="frozen col-1 col-req-id" th:text="${req.reqId}"></td>
                <td class="frozen col-2 col-req-name" th:text="${req.name}"></td>
                <td th:text="${req.businessLeader}"></td>
                <td th:text="${req.techLeader}"></td>
                <!-- === START: 新增数据列 === -->
                <td th:text="${req.leadDepartment}"></td>
                <!-- === START: 新增数据列 === -->
                <td th:text="${req.groupName}"></td>
                <!-- === END: 新增数据列 === -->
                <td th:text="${req.reqType}"></td>
                <!-- === END: 新增数据列 === -->
                <td th:text="${req.businessLine}"></td>
                <td th:text="${req.devLeader}"></td>
                <td class="col-schedule-date" th:text="${req.scheduleDate != null ? #temporals.format(req.scheduleDate, 'yyyy-MM-dd') : ''}"></td>
                <td class="frozen col-last col-actions">
                    <a th:href="@{/requirements/edit/{id}(id=${req.id})}" class="btn btn-warning btn-sm">编辑</a>
                    <a th:href="@{/requirements/delete/{id}(id=${req.id})}"
                       class="btn btn-danger btn-sm ml-2"
                       onclick="return confirm('确定要删除这条需求吗？删除后不可恢复！');">删除</a>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- 分页控件 -->
    <div th:if="${page.totalPages > 0}" class="d-flex justify-content-end mt-3">
        <nav aria-label="Page navigation">
            <ul class="pagination">
                <li class="page-item" th:classappend="${page.first} ? 'disabled'"><a class="page-link" th:href="@{/requirements/(size=${page.size}, page=0, reqId=${reqId})}">首页</a></li>
                <li class="page-item" th:classappend="${page.first} ? 'disabled'"><a class="page-link" th:href="@{/requirements/(size=${page.size}, page=${page.number - 1}, reqId=${reqId})}">上一页</a></li>
                <li class="page-item" th:each="i : ${#numbers.sequence(0, page.totalPages - 1)}" th:classappend="${i == page.number} ? 'active'"><a class="page-link" th:href="@{/requirements/(size=${page.size}, page=${i}, reqId=${reqId})}" th:text="${i + 1}"></a></li>
                <li class="page-item" th:classappend="${page.last} ? 'disabled'"><a class="page-link" th:href="@{/requirements/(size=${page.size}, page=${page.number + 1}, reqId=${reqId})}">下一页</a></li>
                <li class="page-item" th:classappend="${page.last} ? 'disabled'"><a class="page-link" th:href="@{/requirements/(size=${page.size}, page=${page.totalPages - 1}, reqId=${reqId})}">尾页</a></li>
            </ul>
        </nav>
    </div>

    <!-- === START: 新增，文件上传的模态弹窗 === -->
    <div class="modal fade" id="importModal" tabindex="-1" role="dialog" aria-labelledby="importModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="importModalLabel">批量导入需求</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <!-- 文件上传表单 -->
                <form th:action="@{/requirements/import}" method="post" enctype="multipart/form-data">
                    <div class="modal-body">
                        <p>请选择要上传的 CSV 文件。系统将根据“需求编号”跳过已存在的记录。</p>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="csvFile" name="file" accept=".csv" required>
                            <label class="custom-file-label" for="csvFile">选择文件...</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                        <button type="submit" class="btn btn-primary">上传并导入</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- === END === -->
</div>
</body>
</html>
